<p>JPA 2에는 프로그래밍 방식으로 쿼리를 작성하는 데 사용할 수 있는 기준 API가 도입되었습니다. <code>criteria</code>을 작성하여 도메인 클래스에 대한 쿼리의 where 절을 정의합니다. 한 걸음 더 물러서면 이러한 기준은 JPA 기준 API 제약 조건에 의해 설명되는 엔터티에 대한 조건자로 간주될 수 있습니다.</p>
<p>Spring Data JPA는 Eric Evans의 저서 "Domain Driven Design"에서 사양 개념을 가져와 동일한 의미론을 따르고 JPA 기준 API를 사용하여 이러한 사양을 정의하는 API를 제공합니다. 사양을 지원하려면 다음과 같이 <code>JpaSpecificationExecutor</code> 인터페이스를 사용하여 저장소 인터페이스를 확장할 수 있습니다.</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CustomerRepository</span> <span class="token keyword">extends</span> <span class="token class-name">CrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">JpaSpecificationExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
 …
<span class="token punctuation">}</span></code></pre>
<p>추가 인터페이스에는 다양한 방식으로 사양을 실행할 수 있는 메서드가 있습니다. 예를 들어 <code>findAll</code> 메소드는 다음 예와 같이 사양과 일치하는 모든 엔터티를 반환합니다.</p>
<pre><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token class-name">Specification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> spec<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>Specification</code> 인터페이스는 다음과 같이 정의됩니다.</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Specification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token class-name">Predicate</span> <span class="token function">toPredicate</span><span class="token punctuation">(</span><span class="token class-name">Root</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> root<span class="token punctuation">,</span> <span class="token class-name">CriteriaQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> query<span class="token punctuation">,</span>
            <span class="token class-name">CriteriaBuilder</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>사양은 다음 예에 표시된 것처럼 필요한 모든 조합에 대해 쿼리(메서드)를 선언할 필요 없이 <code>JpaRepository</code>와 결합하여 사용할 수 있는 엔터티 위에 확장 가능한 predicate 세트를 구축하는 데 쉽게 사용할 수 있습니다.</p>
<p>Example 1. Specifications for a Customer</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSpecs</span> <span class="token punctuation">{</span>


  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Specification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> <span class="token function">isLongTermCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> query<span class="token punctuation">,</span> builder<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token class-name">LocalDate</span> date <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusYears</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">lessThan</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Customer_</span><span class="token punctuation">.</span>createdAt<span class="token punctuation">)</span><span class="token punctuation">,</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Specification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> <span class="token function">hasSalesOfMoreThan</span><span class="token punctuation">(</span><span class="token class-name">MonetaryAmount</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> query<span class="token punctuation">,</span> builder<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// build query here</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><code>Customer_</code> 유형은 JPA Metamodel 생성기를 사용하여 생성된 메타모델 유형입니다(예제는 Hibernate 구현 문서 참조). 따라서 <code>Customer_.createdAt</code> 표현식은 <code>Customer</code>이 <code>Date</code> 유형의 <code>createAt</code> 속성을 가지고 있다고 가정합니다. 그 외에도 비즈니스 요구 사항 추상화 수준에 대한 몇 가지 기준을 표현하고 실행 가능한 <code>Specifications</code>을 만들었습니다. 따라서 클라이언트는 다음과 같이 <code>Specification</code>을 사용할 수 있습니다.</p>
<p>Example 2. Using a simple Specification</p>
<pre><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> customers <span class="token operator">=</span> customerRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token function">isLongTermCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>이런 종류의 데이터 액세스에 대한 쿼리를 만들어 보는 것은 어떨까요? 단일 <code>Specification</code>을 사용하면 일반 쿼리 선언에 비해 많은 이점을 얻지 못합니다. <code>Specification</code>의 힘은 사양을 결합하여 새로운 <code>Specification</code> 개체를 만들 때 실제로 빛납니다. 다음과 유사한 표현식을 작성하기 위해 우리가 제공하는 <code>Specification</code>의 기본 method을 통해 이를 달성할 수 있습니다.</p>
<p>Example 3. Combined Specifications</p>
<pre><code class="language-java"><span class="token class-name">MonetaryAmount</span> amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MonetaryAmount</span><span class="token punctuation">(</span><span class="token number">200.0</span><span class="token punctuation">,</span> <span class="token class-name">Currencies</span><span class="token punctuation">.</span>DOLLAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> customers <span class="token operator">=</span> customerRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>
  <span class="token function">isLongTermCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">hasSalesOfMoreThan</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>Specification</code>은 <code>Specification</code> 인스턴스를 연결하고 결합하기 위한 몇 가지 "접착 코드" 기본 방법을 제공합니다. 이러한 방법을 사용하면 새로운 <code>Specification</code> 구현을 생성하고 이를 기존 구현과 결합하여 데이터 액세스 계층을 확장할 수 있습니다.</p>
<p>그리고 JPA 2.1에서는 <code>CriteriaBuilder</code> API에 <code>CriteriaDelete</code>가 도입되었습니다. 이는 <code>JpaSpecificationExecutor</code>의 <code>delete(Specification)</code> API를 통해 제공됩니다.</p>
<p>Example 4. Using a Specification to delete entries.</p>
<pre><code class="language-java"><span class="token class-name">Specification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> ageLessThan18 <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">,</span> query<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> cb<span class="token punctuation">.</span><span class="token function">lessThan</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>

userRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>ageLessThan18<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>Specification</code>은 <code>age</code> 필드(정수로 변환)가 <code>18</code> 미만인 기준을 구축합니다. <code>userRepository</code>에 전달되면 JPA의 <code>CriteriaDelete</code> 기능을 사용하여 올바른 <code>DELETE</code> 작업을 생성합니다. 그런 다음 삭제된 엔터티 수를 반환합니다.</p>