<h2 id="1-overview">1. Overview</h2>
<p>이 튜토리얼에서는 Mockito에서 스파이를 최대한 활용하는 방법을 설명합니다.</p>
<p><code>@Spy</code> 어노테이션과 스파이를 스텁하는 방법에 대해 이야기하겠습니다. 마지막으로 <code>Mock</code>과 <code>Spy</code>의 차이점에 대해 살펴보겠습니다.</p>
<p>물론 더 많은 Mockito 장점을 보려면 여기에서 시리즈를 살펴보세요.</p>
<h2 id="2-simple-spy-example">2. Simple <code>Spy</code> Example</h2>
<p>스파이를 사용하는 방법에 대한 간단한 예부터 시작해 보겠습니다. 간단히 말해서 API는 실제 객체를 감시하는 <code>Mockito.spy()</code>입니다.</p>
<p>이를 통해 모의 객체에서와 마찬가지로 모든 상호 작용을 추적하면서 객체의 모든 일반 메서드를 호출할 수 있습니다. 이제 기존 <code>ArrayList</code> 개체를 감시하는 간단한 예를 살펴보겠습니다.</p>
<pre><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">givenUsingSpyMethod_whenSpyingOnList_thenCorrect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> spyList <span class="token operator">=</span> <span class="token function">spy</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    spyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    spyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">verify</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">verify</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertThat</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>실제 메소드 <code>add()</code>가 실제로 호출되는 방식과 <code>spyList</code>의 크기가 2가 되는 방식을 확인하세요.</p>
<h2 id="3-the-spy-annotation">3. The <code>@Spy</code> Annotation</h2>
<p>다음으로 <code>@Spy</code> 어노테이션을 사용하는 방법을 살펴보겠습니다. <code>spy()</code> 대신 <code>@Spy</code> 어노테이션을 사용할 수 있습니다.</p>
<pre><code class="language-java"><span class="token annotation punctuation">@Spy</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> spyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">givenUsingSpyAnnotation_whenSpyingOnList_thenCorrect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    spyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">verify</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">verify</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertThat</span><span class="token punctuation">(</span>aSpyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSize</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Mockito 주석(예: <code>@Spy</code>, <code>@Mock</code>, … )을 활성화하려면 모의 객체를 초기화하고 엄격한 스텁을 처리하는 <code>@ExtendWith(MockitoExtension.class)</code>를 사용해야 합니다.</p>
<h2 id="4-stubbing-a-spy">4. Stubbing a Spy</h2>
<p>이제 <code>Spy</code>를 스텁하는 방법을 살펴보겠습니다. 모의 객체에 사용하는 것과 동일한 구문을 사용하여 메서드의 동작을 configure/oveeride할 수 있습니다. 여기서는 <code>doReturn()</code>을 사용하여 <code>size()</code> 메서드를 재정의합니다.</p>
<pre><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">givenASpy_whenStubbingTheBehaviour_thenCorrect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> spyList <span class="token operator">=</span> <span class="token function">spy</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> spyList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">doReturn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertThat</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSize</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="5-mock-vs-spy-in-mockito">5. <code>Mock</code> vs <code>Spy</code> in <code>Mockito</code></h2>
<p>Mockito에서 <code>Mock</code>과 <code>Spy</code>의 차이점에 대해 논의해 보겠습니다. 우리는 두 개념 사이의 이론적 차이점을 조사하지 않고 Mockito 자체 내에서 어떻게 다른지 살펴보겠습니다.</p>
<p>Mockito가 모의 객체를 생성할 때 실제 인스턴스가 아닌 타입의 <code>Class</code>에서 생성합니다. 모의 객체는 단순히 클래스의 bare-bones 셸 인스턴스를 생성하며 클래스와의 상호 작용을 추적하기 위해 완전히 계측(instrumented)됩니다.</p>
<p>반면에 스파이는 기존 인스턴스를 래핑합니다. 이는 여전히 일반 인스턴스와 동일한 방식으로 작동합니다. 유일한 차이점은 모든 상호 작용을 추적하도록 계측된다는 것입니다.</p>
<p>여기서는 <code>ArrayList</code> 클래스의 모형을 만듭니다.</p>
<pre><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">whenCreateMock_thenCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> mockedList <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mockedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">verify</span><span class="token punctuation">(</span>mockedList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertThat</span><span class="token punctuation">(</span>mockedList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSize</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>보시다시피, 모의 목록에 요소를 추가해도 실제로는 아무것도 추가되지 않습니다. 다른 부작용 없이 메서드를 호출하기만 하면 됩니다.</p>
<p>반면에 스파이는 다르게 행동할 것입니다. 실제로 <code>add</code> 메소드의 실제 구현을 호출하고 기본 목록에 요소를 추가합니다.</p>
<pre><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">whenCreateSpy_thenCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span> spyList <span class="token operator">=</span> <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">spy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    spyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Mockito</span><span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">assertThat</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="6-understatnding-the-mockito-notamockexception">6. Understatnding the Mockito <code>NotAMockException</code></h2>
<p>이 마지막 섹션에서는 Mockito <code>NotAMockException</code>에 대해 알아봅니다. 이 예외는 모의 또는 스파이를 오용할 때 발생할 가능성이 있는 일반적인 예외 중 하나입니다.</p>
<p>이 예외가 발생할 수 있는 상황을 이해하는 것부터 시작하겠습니다.</p>
<pre><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doReturn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>이 코드 조각을 실행하면 다음 오류가 발생합니다.</p>
<pre><code class="language-shell">org.mockito.exceptions.misusing.NotAMockException: 
Argument passed to when<span class="token punctuation">(</span><span class="token punctuation">)</span> is not a mock<span class="token operator">!</span>
Example of correct stubbing:
    doThrow<span class="token punctuation">(</span>new RuntimeException<span class="token punctuation">(</span><span class="token punctuation">))</span>.when<span class="token punctuation">(</span>mock<span class="token punctuation">)</span>.someMethod<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>고맙게도 Mockito 오류 메시지를 보면 여기서 문제가 무엇인지 확실히 알 수 있습니다. 우리의 예에서 <code>list</code> 객체는 모의 객체가 아닙니다. Mockito <code>when()</code> 메소드는 모의 객체 또는 스파이 객체를 인수로 기대합니다.</p>
<p>우리가 볼 수 있듯이 예외 메시지는 올바른 호출이 어떤 모습이어야 하는지까지 설명합니다. 이제 문제가 무엇인지 더 잘 이해했으므로 권장 사항에 따라 문제를 해결해 보겠습니다.</p>
<pre><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> spyList <span class="token operator">=</span> <span class="token function">spy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assertThatNoException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isThrownBy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">doReturn</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>spyList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>이제 예제가 예상대로 작동하며 더 이상 Mockito <code>NotAMockException</code>이 표시되지 않습니다.</p>