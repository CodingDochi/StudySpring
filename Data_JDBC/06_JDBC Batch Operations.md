<p>대부분의 JDBC 드라이버는 동일한 준비된 statement에 대해 여러 호출을 일괄 처리(batch)하는 경우 향상된 성능을 제공합니다. 업데이트를 일괄 처리로 그룹화하면 데이터베이스 왕복(round trips) 횟수를 제한할 수 있습니다.</p>
<h1 id="basic-batch-operations-with-jdbctemplate">Basic Batch Operations with <code>JdbcTemplate</code></h1>
<p>특별한 인터페이스인 <code>BatchPreparedStatementSetter</code>의 두 가지 메소드를 구현하고 해당 구현을 <code>batchUpdate</code> 메소드 호출의 두 번째 매개변수로 전달하여 <code>JdbcTemplate</code> 일괄 처리를 수행합니다. <code>getBatchSize</code> 메소드를 사용하여 현재 배치의 크기를 제공할 수 있습니다. <code>setValues</code> 메소드를 사용하여 준비된 statement의 매개변수 값을 설정할 수 있습니다. 이 메소드는 <code>getBatchSize</code> 호출에서 지정한 횟수만큼 호출됩니다. 다음 예에서는 목록의 항목(entries)을 기반으로 <code>t_actor</code> 테이블을 업데이트하고 전체 목록이 배치로 사용됩니다.</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcActorDao</span> <span class="token keyword">implements</span> <span class="token class-name">ActorDao</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Actor</span><span class="token punctuation">&gt;</span></span> actors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>
				<span class="token string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">BatchPreparedStatementSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setValues</span><span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
						<span class="token class-name">Actor</span> actor <span class="token operator">=</span> actors<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
						ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						ps<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> actors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ... additional methods</span>
<span class="token punctuation">}</span></code></pre>
<p>업데이트 스트림을 처리하거나 파일에서 읽는 경우 선호하는 배치 크기가 있을 수 있지만 마지막 배치에는 해당 개수의 항목이 없을 수 있습니다. 이 경우 입력 소스가 소진되면 배치를 중단할 수 있는 <code>InterruptibleBatchPreparedStatementSetter</code> 인터페이스를 사용할 수 있습니다. <code>isBatchExhausted</code> 메소드를 사용하면 배치 종료를 알릴 수 있습니다.</p>
<h1 id="batch-operations-with-a-list-of-objects">Batch Operations with a List of Objects</h1>
<p><code>JdbcTemplate</code>과 <code>NamedParameterJdbcTemplate</code>은 모두 일괄 업데이트를 제공하는 대체 방법을 제공합니다. 특별한 배치 인터페이스를 구현하는 대신 호출의 모든 매개변수 값을 목록으로 제공합니다. 프레임워크는 이러한 값을 반복하고 내부 준비된 statement setter를 사용합니다. API는 명명된 매개변수 사용 여부에 따라 달라집니다. 명명된 매개 변수의 경우 일괄 처리의 각 구성원에 대해 하나의 항목인 <code>SqlParameterSource</code> 배열을 제공합니다. <code>SqlParameterSourceUtils.createBatch</code> 편의 메서드를 사용하여 이 배열을 생성하고 Bean 스타일 객체(매개변수에 해당하는 getter 메서드 포함), <code>String</code>-키 <code>Map</code> 인스턴스(해당 매개변수를 값으로 포함) 또는 둘 모두를 혼합하여 전달할 수 있습니다. </p>
<p>다음 예에서는 명명된 매개변수를 사용한 일괄 업데이트를 보여줍니다.</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcActorDao</span> <span class="token keyword">implements</span> <span class="token class-name">ActorDao</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">NamedParameterTemplate</span> namedParameterJdbcTemplate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>namedParameterJdbcTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamedParameterJdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Actor</span><span class="token punctuation">&gt;</span></span> actors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namedParameterJdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>
				<span class="token string">"update t_actor set first_name = :firstName, last_name = :lastName where id = :id"</span><span class="token punctuation">,</span>
				<span class="token class-name">SqlParameterSourceUtils</span><span class="token punctuation">.</span><span class="token function">createBatch</span><span class="token punctuation">(</span>actors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ... additional methods</span>
<span class="token punctuation">}</span></code></pre>
<p>클래식 <code>?</code> 자리 표시자를 사용하는 SQL 문의 경우 업데이트 값이 포함된 객체 배열이 포함된 목록을 전달합니다. 이 개체 배열에는 SQL 문의 각 자리 표시자에 대해 하나의 항목이 있어야 하며 SQL 문에 정의된 순서와 동일해야 합니다.</p>
<p>다음 예제는 클래식 JDBC <code>?</code> 자리 표시자를 사용한다는 점을 제외하면 이전 예제와 동일합니다:</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcActorDao</span> <span class="token keyword">implements</span> <span class="token class-name">ActorDao</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Actor</span><span class="token punctuation">&gt;</span></span> actors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Actor</span> actor <span class="token operator">:</span> actors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
					actor<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
			batch<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>
				<span class="token string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span><span class="token punctuation">,</span>
				batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ... additional methods</span>
<span class="token punctuation">}</span></code></pre>
<p>앞에서 설명한 모든 일괄 업데이트 메서드는 각 일괄 항목에 대해 영향을 받는 행 수를 포함하는 <code>int</code> 배열을 반환합니다. 이 개수(count)는 JDBC 드라이버에 의해 보고됩니다. 개수(count)를 사용할 수 없는 경우 JDBC 드라이버는 <code>-2</code> 값을 반환합니다.</p>
<blockquote>
<p><strong>[Note]</strong><br>
이러한 시나리오에서는 기본<code>PreparedStatement</code>의 값이 자동으로 설정되므로 각 값에 해당하는 JDBC 타입이 지정된 Java 타입에서 파생되어야 합니다. 이는 일반적으로 잘 작동하지만 문제가 발생할 가능성이 있습니다(예: 맵에 포함된 <code>null</code> 값). Spring은 이러한 경우 기본적으로 <code>ParameterMetaData.getParameterType</code>을 호출하는데, 이는 JDBC 드라이버에 비용이 많이 들 수 있습니다. 최신 드라이버 버전을 사용해야 하며 성능 문제가 발생하는 경우(Oracle 12c, JBoss 및 PostgreSQL에서 보고된 대로) <code>spring.jdbc.getParameterType.ignore</code> 속성(property)을 <code>true</code>(JVM 시스템 속성으로 또는 <a href="https://docs.spring.io/spring-framework/reference/appendix.html#appendix-spring-properties"><code>SpringProperties</code></a> 메커니즘을 통해)로 설정하는 것을 고려해야 합니다. ).</p>
<p>또는 <code>BatchPreparedStatementSetter</code>(앞서 설명한 대로)를 통하거나, <code>List&lt;Object[]&gt;</code> 기반 호출에 제공된 명시적 유형 배열을 통해, 또는 사용자 정의 <code>MapSqlParameterSource</code> 인스턴스에 대한 <code>registerSqlType</code> 호출을 통해, 또는 Java 선언 속성 타입에서 (null 값에 대해서도) SQL type을 파생시키는 <code>BeanPropertySqlParameterSource</code>를 통해 해당 JDBC 유형을 명시적으로 지정하는 것을 고려할 수 있습니다. </p>
</blockquote>
<h1 id="batch-operations-with-mulitple-batches">Batch Operations with Mulitple Batches</h1>
<p>배치 업데이트의 앞선 예는 너무 커서 여러 개의 작은 배치로 나누고 싶은 배치를 다룹니다. 이전에 언급한 방법으로 <code>batchUpdate</code> 메서드를 여러 번 호출하여 이 작업을 수행할 수 있지만 이제는 더 편리한 방법이 있습니다. 이 메서드는 SQL 문 외에도 매개 변수가 포함된 객체 <code>Collection</code>, 각 배치에 대해 수행할 업데이트 수 및 준비된 statement의 매개 변수 값을 설정하는 <code>ParameterizedPreparedStatementSetter</code>를 사용합니다. 프레임워크는 제공된 값을 반복(loop)하고 업데이트 호출을 지정된 크기의 배치로 나눕니다(break).</p>
<p>다음 예에서는 배치 크기 100을 사용하는 배치 업데이트를 보여줍니다.</p>
<pre><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcActorDao</span> <span class="token keyword">implements</span> <span class="token class-name">ActorDao</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>jdbcTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">batchUpdate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Actor</span><span class="token punctuation">&gt;</span></span> actors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> updateCounts <span class="token operator">=</span> jdbcTemplate<span class="token punctuation">.</span><span class="token function">batchUpdate</span><span class="token punctuation">(</span>
				<span class="token string">"update t_actor set first_name = ?, last_name = ? where id = ?"</span><span class="token punctuation">,</span>
				actors<span class="token punctuation">,</span>
				<span class="token number">100</span><span class="token punctuation">,</span>
				<span class="token punctuation">(</span><span class="token class-name">PreparedStatement</span> ps<span class="token punctuation">,</span> <span class="token class-name">Actor</span> actor<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
					ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					ps<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					ps<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> actor<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> updateCounts<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ... additional methods</span>
<span class="token punctuation">}</span></code></pre>
<p>이 호출에 대한 일괄 업데이트 메서드는 각 업데이트에 대해 영향을 받는 행 수의 배열과 함께 각 일괄 처리에 대한 배열 항목을 포함하는 <code>int</code> 배열의 배열을 반환합니다. 최상위 배열의 길이는 실행된 일괄 처리 수(batch's run)를 나타내고 두 번째 수준 배열의 길이는 해당 일괄 처리의 업데이트 수를 나타냅니다. 각 배치의 업데이트 수는 제공된 총 업데이트 객체 수에 따라 모든 배치에 대해 제공되는 배치 크기(더 적을 수 있는 마지막 배치 제외)여야 합니다. 각 업데이트 문의 업데이트 횟수는 JDBC 드라이버가 보고한 것입니다. 개수를 사용할 수 없는 경우 JDBC 드라이버는 <code>-2</code> 값을 반환합니다.</p>